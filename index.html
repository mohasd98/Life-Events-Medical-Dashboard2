<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TAMM Life Events Medical Hub</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <script>window.react = window.React;</script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
      .hide-scrollbar::-webkit-scrollbar { display: none; }
      .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

      @keyframes popIn {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
      }
      .animate-pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      // --- ICON SYSTEM ---
      const Lucide = window.LucideReact || {};
      const FallbackIcon = (props) => <span {...props} className="inline-block w-4 h-4 bg-slate-200" />;
      const getIcon = (name) => Lucide[name] || FallbackIcon;
      
      const Icons = {
        Baby: getIcon("Baby"),
        HeartPulse: getIcon("HeartPulse"),
        ShieldCheck: getIcon("ShieldCheck"),
        School: getIcon("School"),
        Stethoscope: getIcon("Stethoscope"),
        ClipboardCheck: getIcon("ClipboardCheck"),
        FileText: getIcon("FileText"),
        Sparkles: getIcon("Sparkles"),
        UserRound: getIcon("UserRound"),
        Activity: getIcon("Activity"),
        Users: getIcon("Users"),
        Briefcase: getIcon("Briefcase"),
        Home: getIcon("Home"),
        BookOpen: getIcon("BookOpen"),
        ChevronRight: getIcon("ChevronRight"),
        Search: getIcon("Search"),
        Send: getIcon("Send"),
        CheckCircle2: getIcon("CheckCircle2"),
        AlertTriangle: getIcon("AlertTriangle"),
        HeartHandshake: getIcon("HeartHandshake"),
        GraduationCap: getIcon("GraduationCap"),
        Calendar: getIcon("Calendar"),
        MapPin: getIcon("MapPin"),
        Clock: getIcon("Clock"),
        X: getIcon("X"),
        ArrowRight: getIcon("ArrowRight"),
        Building2: getIcon("Building2"),
        Bot: getIcon("Bot"),
        Circle: getIcon("Circle"),
        HandHeart: getIcon("HandHeart"),
        Link2: getIcon("Link2"),
        MessageCircle: getIcon("MessageCircle"),
        User: getIcon("User"),
        Accessibility: getIcon("Accessibility"),
        Plane: getIcon("Plane"),
        Info: getIcon("Info"),
        ChevronDown: getIcon("ChevronDown"),
        List: getIcon("List"),
        Table2: getIcon("Table2"),
        ListTodo: getIcon("ListTodo"),
        Edit3: getIcon("Edit3"),
        Loader2: getIcon("Loader2"),
        Eye: getIcon("Eye"),
        EyeOff: getIcon("EyeOff"),
        Gift: getIcon("Gift"),
        Mail: getIcon("Mail"),
        ArrowLeft: getIcon("ArrowLeft"),
        Settings2: getIcon("Settings2"),
        CheckSquare: getIcon("CheckSquare"),
        Square: getIcon("Square"),
        Wand2: getIcon("Wand2"),
        Lightbulb: getIcon("Lightbulb"),
        FileHeart: getIcon("FileHeart"),
        MessagesSquare: getIcon("MessagesSquare"),
        Pencil: getIcon("Pencil"),
        Plus: getIcon("Plus"),
        GitBranch: getIcon("GitBranch"),
        Smartphone: getIcon("Smartphone"),
        Globe: getIcon("Globe"),
        Moon: getIcon("Moon"),
        Users2: getIcon("Users2"),
        Bike: getIcon("Bike"),
        QrCode: getIcon("QrCode"),
        Shield: getIcon("Shield"),
        FileCheck: getIcon("FileCheck"),
      };

      // --- UI COMPONENTS ---

      const Card = ({ className, children, onClick }) => (
        <div onClick={onClick} className={`rounded-2xl border border-slate-200 bg-white text-slate-950 shadow-sm ${className || ""} ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}>{children}</div>
      );
      const CardHeader = ({ className, children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className || ""}`}>{children}</div>;
      const CardTitle = ({ className, children }) => <h3 className={`text-xl font-bold leading-none tracking-tight text-slate-900 ${className || ""}`}>{children}</h3>;
      const CardDescription = ({ className, children }) => <p className={`text-sm text-slate-500 ${className || ""}`}>{children}</p>;
      const CardContent = ({ className, children }) => <div className={`p-6 pt-0 ${className || ""}`}>{children}</div>;

      const Button = ({ className, variant = "default", size = "default", children, ...props }) => {
        const variants = {
          default: "bg-teal-700 text-white hover:bg-teal-800 shadow-md shadow-teal-900/10",
          outline: "border border-slate-200 bg-white hover:bg-slate-50 text-slate-900",
          ghost: "hover:bg-slate-100 text-slate-700",
          secondary: "bg-slate-100 text-slate-900 hover:bg-slate-200",
          purple: "bg-purple-600 text-white hover:bg-purple-700 shadow-md shadow-purple-600/20", 
        };
        const sizes = { default: "h-10 px-4 py-2", sm: "h-8 rounded-lg px-3 text-xs", icon: "h-10 w-10" };
        return (
          <button className={`inline-flex items-center justify-center whitespace-nowrap rounded-xl text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-slate-950 ${variants[variant]} ${sizes[size]} ${className || ""}`} {...props}>{children}</button>
        );
      };

      const Badge = ({ className, variant = "default", children }) => {
        const variants = {
          default: "bg-slate-900 text-white",
          secondary: "bg-slate-100 text-slate-900",
          outline: "border border-slate-200 text-slate-600",
          teal: "bg-teal-50 text-teal-700 border border-teal-200",
          amber: "bg-amber-50 text-amber-700 border border-amber-200",
          success: "bg-emerald-50 text-emerald-700 border border-emerald-200",
          purple: "bg-purple-50 text-purple-700 border border-purple-200",
          red: "bg-red-50 text-red-700 border border-red-200",
        };
        return <div className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold ${variants[variant]} ${className || ""}`}>{children}</div>;
      };

      const Progress = ({ value, className }) => (
        <div className={`relative h-3 w-full overflow-hidden rounded-full bg-slate-100 ${className || ''}`}>
          <div className="h-full bg-teal-600 transition-all duration-500 ease-in-out" style={{ width: `${value}%` }} />
        </div>
      );

      const Separator = ({ className }) => <div className={`h-[1px] w-full bg-slate-200 ${className || ''}`} />;

      const Input = ({ className, ...props }) => (
        <input
          className={`flex h-10 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-teal-700 disabled:cursor-not-allowed disabled:opacity-50 ${className || ''}`}
          {...props}
        />
      );

      // --- DATA FACTORY ---

      const getPersonas = (babyName, revealedGender) => ({
        citizen: {
          label: "Citizen family",
          familyName: "Al Nuaimi Family",
          parents: "Omar & Aisha",
          expectedBaby: babyName ? `Baby ${babyName}` : (revealedGender ? `Baby ${revealedGender}` : "Expecting Baby"),
          location: "Abu Dhabi",
          benefitsLabel: "Family Book Path",
          features: ["Mabrouk Ma Yak", "Genome Testing", "School Seat Reserve"]
        },
        resident: {
          label: "Resident family",
          familyName: "Khan Family",
          parents: "Hassan & Mariam",
          expectedBaby: babyName ? `Baby ${babyName}` : (revealedGender ? `Baby ${revealedGender}` : "Expecting Baby"),
          location: "Abu Dhabi",
          benefitsLabel: "Resident Path",
          features: ["MOFA Attestation", "Embassy Passport", "Civil Marriage"]
        }
      });

      // --- AI INSIGHTS DATA ---
      const getAIInsights = (persona, stage, profileType) => {
        const isCitizen = persona === 'citizen';
        const baseInsights = [];

        if (profileType === 'father') {
            baseInsights.push({ type: 'service', title: 'Mobile Home Care', desc: 'Schedule a nurse visit for your father.', icon: 'Stethoscope' });
            baseInsights.push({ type: 'education', title: 'Caregiver Support', desc: 'Resources for family members supporting elderly.', icon: 'BookOpen' });
            return baseInsights;
        }

        if (profileType === 'family') {
             if (stage === 'newborn') baseInsights.push({ type: 'education', title: 'Breastfeeding Guide', desc: 'Support for the first 6 months.', icon: 'HeartPulse' });
             if (stage === 'school_age') baseInsights.push({ type: 'service', title: 'School Vaccination', desc: 'Check upcoming school health campaigns.', icon: 'ShieldCheck' });
             return baseInsights;
        }

        // Default "Myself" Logic
        if (stage === 'premarital') {
            baseInsights.push({ type: 'education', title: 'Why Genetic Screening Matters', desc: 'Understanding your compatibility results.', icon: 'BookOpen' });
            if (isCitizen) baseInsights.push({ type: 'service', title: 'Medeem Marriage Grant', desc: 'Check if you qualify for financial support.', icon: 'Gift' });
        }
        else if (stage === 'marriage') {
            baseInsights.push({ type: 'tip', title: 'Plan Your Ceremony', desc: 'Authorized officiants are available on weekends.', icon: 'Lightbulb' });
        }
        else if (stage === 'maternity') {
            baseInsights.push({ type: 'education', title: 'Nutrition: Trimester 1', desc: 'Essential foods for you and your baby.', icon: 'HeartPulse' });
        }
        else if (stage === 'adult') {
             baseInsights.push({ type: 'service', title: 'Ifhas Screening', desc: 'Book your comprehensive annual checkup.', icon: 'Activity' });
        }

        if (baseInsights.length === 0) {
            baseInsights.push({ type: 'tip', title: 'Update Contact Info', desc: 'Ensure your phone number is current.', icon: 'Settings2' });
        }

        return baseInsights;
      };

      // --- MAIN JOURNEY DATA ---
      const getJourneyData = (persona, babyName, revealedGender) => {
        const isCitizen = persona === 'citizen';
        
        const birthJourney = isCitizen ? {
          title: "Mabrouk Ma Yak",
          subtitle: "Newborn Bundle",
          icon: "Baby",
          description: "One request to issue all your newborn's official documents: Birth Certificate, ID, Passport, and Family Book.",
          status: "Action Required",
          steps: [
            { title: "Notification", desc: "Hospital submits birth details.", status: "completed", channel: "Provider Console", entity: "Hospital" },
            { title: "Photo & Name", desc: babyName ? `Named: ${babyName}` : "Baby photo captured. Choose name.", status: babyName ? "completed" : "current", actionLabel: "Start Naming", channel: "TAMM", entity: "DoH" },
            { title: "Bundle Processing", desc: "We issue Birth Certificate, EID, and Passport together.", status: babyName ? "current" : "upcoming", channel: "Backend", entity: "ICP" },
            { title: "Delivery", desc: "Digital docs in Wallet. Physical cards delivered.", status: "upcoming", channel: "TAMM Wallet", entity: "ICP" }
          ]
        } : {
          title: "Birth & Residency",
          subtitle: "Certificate & Visa",
          icon: "FileText",
          description: "Issue the Birth Certificate, attest it, and proceed with Residency issuance.",
          status: "Action Required",
          steps: [
            { title: "Notification", desc: "Hospital submits birth details.", status: "completed", channel: "Provider Console", entity: "Hospital" },
            { title: "Birth Certificate", desc: babyName ? `Certificate for ${babyName}` : "Review details and name baby.", status: babyName ? "completed" : "current", actionLabel: "Issue Certificate", channel: "TAMM", entity: "DoH" },
            { title: "Attestation", desc: "Digital MOFA attestation (if needed).", status: babyName ? "current" : "upcoming", channel: "TAMM", entity: "MOFA" },
            { title: "Residency", desc: "Apply for Passport (Embassy) then Residency (ICP).", status: "upcoming", channel: "Embassy/ICP", entity: "Foreign Mission/ICP" }
          ]
        };

        return {
          premarital: {
            title: "Premarital Screening",
            subtitle: "Health readiness & Genetics",
            icon: "HeartHandshake",
            description: "Complete your screening to ensure a healthy future family. Results are valid for 3 months.",
            status: "Completed",
            steps: [
              { title: "Check Requirements", desc: "View the checklist for citizens vs residents.", status: "completed", channel: "TAMM", entity: "DCD/ADJD" },
              { title: "Book Appointment", desc: "Choose a SEHA facility near you.", status: "completed", channel: "TAMM Sahatna", entity: "SEHA" },
              { title: "Attend Screening", desc: `Complete lab tests${isCitizen ? " (Genome included)." : "."}`, status: "completed", channel: "Clinic", entity: "SEHA" },
              { title: "Receive Results", desc: "Your certificate will be issued digitally.", status: "completed", channel: "TAMM", entity: "DoH" },
              { title: "Marriage Readiness", desc: "Your status will automatically update for ADJD.", status: "completed", channel: "Backend", entity: "DoH -> ADJD" }
            ]
          },
          marriage: {
            title: "Marriage Contract",
            subtitle: "Legal & Religious",
            icon: "Users",
            description: "Apply for your marriage contract digitally. We've pre-filled your details.",
            status: "In Progress",
            steps: [
              { title: "Application", desc: "Start your marriage file with ADJD.", status: "completed", channel: "TAMM", entity: "ADJD" },
              { title: "Eligibility Check", desc: "We verify your premarital screening status.", status: "completed", channel: "Backend", entity: "DoH" },
              { title: "Book Ceremony", desc: "Choose a court or authorized officiant.", status: "current", channel: "TAMM", entity: "ADJD" },
              { title: "Digital Contract", desc: "Receive your official marriage contract instantly.", status: "upcoming", channel: "TAMM Wallet", entity: "ADJD" },
              isCitizen ? { title: "Family Update", desc: "Your Family Book updates automatically.", status: "upcoming", channel: "Backend", entity: "ICP" } : null
            ].filter(Boolean)
          },
          preconception: {
            title: "Planning a Baby",
            subtitle: "Pre-conception Support",
            icon: "HeartPulse",
            description: "Optional health checks and support for starting a family.",
            status: "Future",
            steps: [
              { title: "Health Profile", desc: "Complete your baseline health check.", status: "upcoming", channel: "TAMM", entity: "DoH" },
              { title: "Education", desc: "Access preparation guides.", status: "upcoming", channel: "TAMM", entity: "DoH" },
              { title: "Clinical Consult", desc: "Book a pre-conception visit if needed.", status: "upcoming", channel: "Clinic", entity: "SEHA/Private" },
              { title: "IVF Support", desc: "Eligibility and referral if applicable.", status: "upcoming", channel: "TAMM", entity: "DoH" },
              { title: "Maternity Handoff", desc: "Seamless transition to pregnancy care.", status: "upcoming", channel: "Backend", entity: "DoH -> Malaffi" }
            ]
          },
          maternity: {
            title: "Maternity Journey",
            subtitle: "Antenatal to Delivery",
            icon: "Stethoscope",
            description: "Track your pregnancy milestones, appointments, and care plan.",
            status: "In Progress",
            steps: [
              { title: "Confirm Pregnancy", desc: "Register your maternity file.", status: "completed", channel: "TAMM Sahatna", entity: "DoH" },
              { title: "Care Plan", desc: "View your 9-visit antenatal schedule.", status: "current", channel: "TAMM Sahatna", entity: "DoH" },
              { title: "Gender Reveal", desc: revealedGender ? `It's a ${revealedGender}!` : "Ultrasound results ready.", status: revealedGender ? "completed" : "current", actionLabel: revealedGender ? null : "Reveal Gender", channel: "TAMM", entity: "DoH" },
              { title: "Pre-Capture IDs", desc: "Upload parent docs now to save time at birth.", status: "upcoming", channel: "TAMM", entity: "ICP" },
              { title: "Birth Notification", desc: "Provider submits data.", status: "upcoming", systemNote: "Pre-filled from Malaffi", channel: "Provider", entity: "Hospital" }
            ]
          },
          birth: birthJourney,
          child_health: {
            title: "Child Health (0-12)",
            subtitle: "Vaccines & Development",
            icon: "ShieldCheck",
            description: "Manage your child's vaccinations, screenings, and development milestones.",
            status: "Action Required",
            steps: [
              { title: "Newborn Screening", desc: "Hearing, Heart, and Metabolic checks.", status: "current", channel: "Hospital", entity: "DoH" },
              { title: "Results", desc: "View results (reported to MOHAP).", status: "upcoming", channel: "TAMM", entity: "DoH" },
              { title: "Vaccine Schedule", desc: "View required vaccines timeline.", status: "upcoming", channel: "TAMM", entity: "DoH" },
              { title: "School Readiness", desc: "Vaccine status shared with ADEK.", status: "upcoming", channel: "Backend", entity: "ADEK" }
            ]
          },
          adolescent: {
            title: "Adolescent Health (13-18)",
            subtitle: "Growth & Wellbeing",
            icon: "UserRound",
            description: "Health tracking during teenage years, including mental wellbeing and puberty checks.",
            status: "Future",
            steps: [
              { title: "Annual Checkup", desc: "Physical growth tracking.", status: "upcoming", channel: "Clinic", entity: "DoH" },
              { title: "HPV Vaccine", desc: "Scheduled immunization.", status: "upcoming", channel: "School/Clinic", entity: "DoH" },
              { title: "Mental Wellbeing", desc: "Self-assessment and support.", status: "upcoming", channel: "TAMM", entity: "DoH" }
            ]
          },
          adult: { 
            title: "Adult Health (19+)", 
            subtitle: "Prevention & Wellness", 
            icon: "Activity", 
            description: "Wellness checks and preventive care for adults.", 
            status: "Future",
            steps: [
                {title: "Ifhas Screening", desc: "Comprehensive annual checkup", status: "upcoming", channel: "Clinic", entity: "DoH"},
                {title: "Chronic Disease", desc: "Risk assessment", status: "upcoming", channel: "TAMM", entity: "DoH"}
            ] 
          },
          elderly: { 
            title: "Elderly Care", 
            subtitle: "Support & Dignity", 
            icon: "Users", 
            description: "Home care, medical equipment, and caregiver support for your parent.",
            status: "Active",
            steps: [
                {title: "Geriatric Assessment", desc: "Book review", status: "current", channel: "TAMM", entity: "DoH"},
                {title: "Home Care", desc: "Request mobile support", status: "upcoming", channel: "TAMM", entity: "DoH/DCD"},
                {title: "Assistive Devices", desc: "Wheelchair/Bed request", status: "upcoming", channel: "TAMM", entity: "ZHO"}
            ] 
          },
          sanadkom: { 
            title: "Sanadkom", 
            subtitle: "End of Life", 
            icon: "Heart", 
            description: "Bereavement support and official procedures.", 
            status: "Future",
            steps: [
                {title: "Notification", desc: "Hospital reports death", status: "upcoming", channel: "Provider", entity: "Hospital"}, 
                {title: "Certificate", desc: "Digital death certificate", status: "upcoming", channel: "TAMM", entity: "DoH"}, 
                {title: "Benefits", desc: "Sanadkom support launch", status: "upcoming", channel: "TAMM", entity: "DCD"},
                {title: "Permits", desc: "Burial/Transport", status: "upcoming", channel: "TAMM", entity: "Municipalities"}
            ]
          },
          housing: {
            title: "Housing & Support",
            subtitle: "ISKAN & Benefits",
            icon: "Home",
            description: "Apply for housing grants and social allowances.",
            status: "In Progress",
            steps: [
              { title: "Eligibility Check", desc: "Check if you qualify.", status: "completed", channel: "TAMM", entity: "ISKAN" },
              { title: "Application", desc: "Submit your request.", status: "current", channel: "TAMM", entity: "ISKAN" },
              { title: "Committee Review", desc: "Wait for decision.", status: "upcoming", channel: "Backend", entity: "ISKAN" }
            ]
          },
          work: {
            title: "Work & Leave",
            subtitle: "Employment Support",
            icon: "Briefcase",
            description: "Manage maternity/paternity leave and return to work.",
            status: "Future",
            steps: [
              { title: "Employer Sync", desc: "Link employment record.", status: "upcoming", channel: "TAMM", entity: "MOHRE" },
              { title: "Leave Request", desc: "Apply for leave.", status: "upcoming", channel: "TAMM", entity: "Employer" },
              { title: "Return to Work", desc: "Confirm return date.", status: "upcoming", channel: "TAMM", entity: "Employer" }
            ]
          },
          university: {
            title: "University Admission",
            subtitle: "Health Clearance",
            icon: "BookOpen",
            description: "Complete medical fitness tests required for university admission.",
            status: "Future",
            steps: [
                {title: "Admission Exam", desc: "Book medical fitness test.", status: "upcoming", channel: "TAMM Sahatna", entity: "SEHA"},
                {title: "Vaccine Update", desc: "Ensure boosters are current.", status: "upcoming", channel: "Clinic", entity: "DoH"},
                {title: "Clearance Certificate", desc: "Digital fitness certificate.", status: "upcoming", channel: "TAMM Wallet", entity: "DoH"}
            ]
          },
          work_screening: {
            title: "Work Fitness",
            subtitle: "Employment Medical",
            icon: "Briefcase",
            description: "Mandatory health screening for new employment or visa renewal.",
            status: "Future",
            steps: [
                {title: "Book Screening", desc: "Schedule visa medical.", status: "upcoming", channel: "TAMM Sahatna", entity: "DOH/SEHA"},
                {title: "Visit Center", desc: "Complete blood test & X-ray.", status: "upcoming", channel: "Screening Center", entity: "SEHA"},
                {title: "Fitness Certificate", desc: "Result sent to ICP/MOHRE.", status: "upcoming", channel: "Backend", entity: "DoH"}
            ]
          },
          hajj: {
            title: "Hajj & Umrah",
            subtitle: "Health Permit",
            icon: "Moon",
            description: "Health requirements for pilgrims.",
            status: "Future",
            steps: [
                {title: "Vaccination", desc: "Meningitis & Flu shots.", status: "upcoming", channel: "Clinic", entity: "DoH"},
                {title: "Health Card", desc: "Issue pilgrim health card.", status: "upcoming", channel: "TAMM Wallet", entity: "DoH"}
            ]
          }
        };
      };

      // --- COMPONENTS ---

      // Document Preview Modal
      function DocumentPreviewModal({ isOpen, onClose, docType, persona, babyName }) {
         if (!isOpen) return null;

         const activePersona = persona === 'citizen' ? "Omar Al Nuaimi" : "Hassan Khan";
         const baby = babyName || (persona === 'citizen' ? "Noor Al Nuaimi" : "Lina Khan");

         return (
             <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                 <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200">
                     <div className="bg-slate-900 p-4 flex justify-between items-center text-white">
                         <div className="flex items-center gap-2">
                             <Icons.FileText className="h-5 w-5" />
                             <span className="font-semibold">Digital Document Viewer</span>
                         </div>
                         <button onClick={onClose}><Icons.X className="h-5 w-5" /></button>
                     </div>
                     <div className="p-8 bg-slate-50 flex flex-col items-center">
                         {/* Document Canvas */}
                         <div className="bg-white border-2 border-slate-200 w-full aspect-[1/1.4] shadow-lg p-8 relative flex flex-col">
                             {/* Header */}
                             <div className="flex justify-between items-start mb-8">
                                 <div className="text-center w-full">
                                     <div className="mx-auto w-12 h-12 bg-slate-900 rounded-full flex items-center justify-center mb-2 text-white">
                                         <Icons.Shield className="h-6 w-6" />
                                     </div>
                                     <h2 className="text-xl font-serif font-bold text-slate-900 uppercase tracking-widest">{docType}</h2>
                                     <div className="text-[10px] text-slate-500 uppercase tracking-widest">United Arab Emirates</div>
                                 </div>
                             </div>

                             {/* Content */}
                             <div className="flex-1 space-y-6">
                                 {docType === 'Family Book' && (
                                     <>
                                         <div className="border-b border-slate-100 pb-2">
                                             <div className="text-[10px] text-slate-400 uppercase">Head of Family</div>
                                             <div className="text-lg font-medium font-serif">{activePersona}</div>
                                         </div>
                                         <div className="border-b border-slate-100 pb-2">
                                             <div className="text-[10px] text-slate-400 uppercase">Status</div>
                                             <div className="text-sm font-medium">Citizen - Abu Dhabi</div>
                                         </div>
                                         <div className="border-b border-slate-100 pb-2">
                                              <div className="text-[10px] text-slate-400 uppercase">Dependents</div>
                                              <div className="text-sm">Aisha (Spouse), {baby} (Child)</div>
                                         </div>
                                     </>
                                 )}
                                 {docType === 'Birth Certificate' && (
                                     <>
                                         <div className="border-b border-slate-100 pb-2">
                                             <div className="text-[10px] text-slate-400 uppercase">Name of Child</div>
                                             <div className="text-xl font-medium font-serif text-teal-800">{baby}</div>
                                         </div>
                                         <div className="grid grid-cols-2 gap-4">
                                            <div className="border-b border-slate-100 pb-2">
                                                <div className="text-[10px] text-slate-400 uppercase">Date of Birth</div>
                                                <div className="text-sm font-medium">15 DEC 2025</div>
                                            </div>
                                            <div className="border-b border-slate-100 pb-2">
                                                <div className="text-[10px] text-slate-400 uppercase">Place of Birth</div>
                                                <div className="text-sm font-medium">Abu Dhabi</div>
                                            </div>
                                         </div>
                                         <div className="border-b border-slate-100 pb-2">
                                              <div className="text-[10px] text-slate-400 uppercase">Father's Name</div>
                                              <div className="text-sm">{activePersona}</div>
                                         </div>
                                     </>
                                 )}
                                 {docType === 'Marriage Contract' && (
                                     <>
                                         <div className="grid grid-cols-2 gap-8 border-b border-slate-100 pb-4">
                                             <div>
                                                 <div className="text-[10px] text-slate-400 uppercase">Husband</div>
                                                 <div className="text-lg font-serif">{activePersona}</div>
                                             </div>
                                             <div className="text-right">
                                                 <div className="text-[10px] text-slate-400 uppercase">Wife</div>
                                                 <div className="text-lg font-serif">{persona === 'citizen' ? 'Aisha' : 'Mariam'}</div>
                                             </div>
                                         </div>
                                         <div className="text-center pt-4">
                                             <div className="text-[10px] text-slate-400 uppercase">Date of Marriage</div>
                                             <div className="text-sm font-medium">12 MAR 2024</div>
                                         </div>
                                     </>
                                 )}
                             </div>

                             {/* Footer */}
                             <div className="mt-8 flex justify-between items-end">
                                 <div className="text-center">
                                     <Icons.QrCode className="h-16 w-16 text-slate-800" />
                                     <div className="text-[8px] text-slate-400 mt-1">SCAN TO VERIFY</div>
                                 </div>
                                 <div className="text-right">
                                     <div className="h-12 w-12 rounded-full border-2 border-teal-700/30 flex items-center justify-center text-[10px] text-teal-800 font-bold uppercase rotate-12">
                                         Official<br/>Document
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div className="flex gap-3 mt-6 w-full">
                             <Button className="flex-1 bg-slate-900 text-white"><Icons.CheckCircle2 className="mr-2 h-4 w-4" /> Valid</Button>
                             <Button variant="outline" className="flex-1"><Icons.Send className="mr-2 h-4 w-4" /> Share</Button>
                         </div>
                         <Button variant="ghost" onClick={onClose} className="w-full mt-2 text-slate-500">Back to Dashboard</Button>
                     </div>
                 </div>
             </div>
         );
      }

      function BabyNamingModal({ isOpen, onClose, onNameSubmit, persona }) {
        const [firstNameEn, setFirstNameEn] = useState("");
        const [firstNameAr, setFirstNameAr] = useState("");
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [aiPrompt, setAiPrompt] = useState("");
        const [aiSuggestions, setAiSuggestions] = useState([]);
        const [isGenerating, setIsGenerating] = useState(false);
        if (!isOpen) return null;
        const handleSubmit = () => { setIsSubmitting(true); setTimeout(() => { setIsSubmitting(false); onNameSubmit(firstNameEn); onClose(); }, 1500); };
        const handleAiGenerate = () => { if (!aiPrompt) return; setIsGenerating(true); setAiSuggestions([]); setTimeout(() => { setIsGenerating(false); let results = ["Zayed", "Rashid", "Khalifa"]; if (aiPrompt.toLowerCase().includes("r")) results = ["Rashed", "Reem", "Rawda"]; if (aiPrompt.toLowerCase().includes("girl")) results = ["Latifa", "Shamsa", "Fatima"]; if (aiPrompt.toLowerCase().includes("modern")) results = ["Ayla", "Zain", "Kayan"]; setAiSuggestions(results); }, 1500); };
        const selectSuggestion = (name) => { setFirstNameEn(name); setFirstNameAr("..."); };
        return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-in fade-in zoom-in duration-200 overflow-hidden"><div className="flex items-center justify-between mb-4"><h3 className="text-xl font-bold text-slate-900">Name Your Baby</h3><button onClick={onClose}><Icons.X className="h-5 w-5 text-slate-400" /></button></div><div className="space-y-4"><div className="bg-purple-50 p-4 rounded-xl border border-purple-100 mb-4"><div className="flex items-center gap-2 mb-2"><Icons.Sparkles className="h-4 w-4 text-purple-600" /><h4 className="text-sm font-bold text-purple-900">Need inspiration? Ask AI</h4></div><div className="flex gap-2"><Input value={aiPrompt} onChange={(e) => setAiPrompt(e.target.value)} placeholder="e.g. Traditional names starting with R" className="bg-white border-purple-200 focus:ring-purple-500 h-9 text-xs" /><Button variant="purple" size="sm" className="h-9 px-3" onClick={handleAiGenerate} disabled={!aiPrompt || isGenerating}>{isGenerating ? <Icons.Loader2 className="h-3 w-3 animate-spin" /> : <Icons.Wand2 className="h-3 w-3" />}</Button></div>{aiSuggestions.length > 0 && (<div className="mt-3 flex flex-wrap gap-2 animate-in slide-in-from-top-2">{aiSuggestions.map(name => (<button key={name} onClick={() => selectSuggestion(name)} className="bg-white border border-purple-200 text-purple-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-purple-100 transition-colors">{name}</button>))}</div>)}</div><div className="bg-blue-50 p-3 rounded-lg flex items-start gap-2"><Icons.Info className="h-5 w-5 text-blue-600 mt-0.5" /><p className="text-xs text-blue-800">We will check your chosen name against {persona === 'citizen' ? 'ICP' : 'Official'} naming rules.</p></div><div><label className="block text-sm font-medium text-slate-700 mb-1">First Name (English)</label><Input value={firstNameEn} onChange={(e) => setFirstNameEn(e.target.value)} placeholder="e.g. Zayed" /></div><div><label className="block text-sm font-medium text-slate-700 mb-1">First Name (Arabic)</label><Input value={firstNameAr} onChange={(e) => setFirstNameAr(e.target.value)} placeholder="e.g. زايد" className="text-right" /></div><div className="pt-2"><div className="text-xs text-slate-500 mb-1">Family Name (Fixed)</div><div className="font-semibold text-slate-900 bg-slate-100 px-3 py-2 rounded-lg">{persona === 'citizen' ? 'Al Nuaimi' : 'Khan'}</div></div><Button onClick={handleSubmit} className="w-full mt-2" disabled={!firstNameEn || !firstNameAr || isSubmitting}>{isSubmitting ? (<span className="flex items-center gap-2"><Icons.Loader2 className="h-4 w-4 animate-spin" /> Checking Rules...</span>) : "Confirm Name"}</Button></div></div></div>);
      }

      function GenderRevealModal({ isOpen, onClose, onReveal }) {
        const [isRevealed, setIsRevealed] = useState(false);
        const [gender, setGender] = useState(null); 
        const [showSurpriseForm, setShowSurpriseForm] = useState(false);
        const [contactName, setContactName] = useState("");
        const [contactInfo, setContactInfo] = useState("");
        const [isSending, setIsSending] = useState(false);
        const [isSent, setIsSent] = useState(false);
        useEffect(() => { if (isOpen && !isRevealed && !isSent) { setGender("Boy"); setShowSurpriseForm(false); } }, [isOpen, isRevealed, isSent]);
        const handleReveal = () => { setIsRevealed(true); setTimeout(() => { onReveal(gender); }, 500); };
        const handleSurpriseClick = () => { setShowSurpriseForm(true); };
        const handleSendSurprise = () => { setIsSending(true); setTimeout(() => { setIsSending(false); setIsSent(true); }, 1500); };
        const handleClose = () => { onClose(); setTimeout(() => { setIsRevealed(false); setShowSurpriseForm(false); setIsSent(false); }, 500); };
        if (!isOpen) return null;
        return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md"><div className="bg-white rounded-3xl w-full max-w-sm p-0 shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300 relative"><button onClick={handleClose} className="absolute top-4 right-4 z-10 p-2 bg-white/20 rounded-full hover:bg-white/40 transition-colors"><Icons.X className={`h-6 w-6 ${isRevealed ? 'text-white' : 'text-slate-400'}`} /></button>{!isRevealed && !showSurpriseForm && (<div className="p-8 text-center space-y-6"><div className="mx-auto w-24 h-24 bg-teal-50 rounded-full flex items-center justify-center mb-4"><Icons.Gift className="h-12 w-12 text-teal-600" /></div><div><h3 className="text-2xl font-bold text-slate-900 mb-2">Ready to see?</h3><p className="text-slate-500 text-sm">The ultrasound results are in. You can reveal the gender now, or keep it a surprise for a special moment.</p></div><div className="space-y-3"><Button onClick={handleReveal} className="w-full h-12 text-base shadow-lg shadow-teal-500/20">Reveal Gender</Button><Button onClick={handleSurpriseClick} variant="ghost" className="w-full">Keep it a Surprise</Button></div><div className="flex items-center justify-center gap-2 text-xs text-slate-400"><Icons.ShieldCheck className="h-3 w-3" /> Secure & Private</div></div>)}{!isRevealed && showSurpriseForm && !isSent && (<div className="p-8 space-y-4"><div className="flex items-center gap-2 mb-2"><button onClick={() => setShowSurpriseForm(false)} className="p-1 -ml-2 rounded-full hover:bg-slate-100"><Icons.ArrowLeft className="h-5 w-5 text-slate-500"/></button><h3 className="text-xl font-bold text-slate-900">Surprise a Loved One</h3></div><p className="text-sm text-slate-500">We will send a secure, locked digital envelope to your trusted contact. Only they can unlock the gender result.</p><div><label className="block text-sm font-medium text-slate-700 mb-1">Contact Name</label><Input value={contactName} onChange={(e) => setContactName(e.target.value)} placeholder="e.g. My Sister" /></div><div><label className="block text-sm font-medium text-slate-700 mb-1">Email or Phone</label><Input value={contactInfo} onChange={(e) => setContactInfo(e.target.value)} placeholder="e.g. 050xxxxxxx" /></div><Button onClick={handleSendSurprise} className="w-full mt-2" disabled={!contactName || !contactInfo || isSending}>{isSending ? (<span className="flex items-center gap-2"><Icons.Loader2 className="h-4 w-4 animate-spin" /> Sending...</span>) : `Send to ${contactName || 'Contact'}`}</Button></div>)}{!isRevealed && isSent && (<div className="p-10 text-center space-y-6"><div className="mx-auto w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-4"><Icons.Mail className="h-10 w-10 text-green-600" /></div><div><h3 className="text-xl font-bold text-slate-900">Sent Successfully!</h3><p className="text-slate-500 text-sm mt-2">The results have been securely sent to <strong>{contactName}</strong>. They can now plan the reveal for you!</p></div><Button onClick={handleClose} variant="outline" className="w-full">Close</Button></div>)}{isRevealed && (<div className={`p-10 text-center flex flex-col items-center justify-center min-h-[400px] transition-colors duration-1000 ${gender === 'Boy' ? 'bg-blue-500' : 'bg-pink-500'}`}><div className="animate-pop-in"><div className="mx-auto w-32 h-32 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center mb-6 shadow-xl ring-4 ring-white/30"><Icons.Baby className="h-16 w-16 text-white" /></div><h2 className="text-4xl font-extrabold text-white mb-2 tracking-tight">It's a {gender}!</h2><p className="text-white/90 text-lg">Congratulations!</p></div><div className="mt-12 w-full"><Button onClick={handleClose} className="w-full bg-white text-slate-900 hover:bg-white/90 border-0 shadow-xl">Start Planning</Button></div></div>)}</div></div>);
      }

      function JourneyTimeline({ data, onAction }) {
        if (!data || !data.steps || !data.steps.length) return <div className="text-sm text-slate-400 italic p-4">Timeline available upon activation.</div>;
        return (
          <div className="mt-6 relative pl-4 border-l-2 border-slate-100 space-y-8">
            {data.steps.map((step, i) => {
              const isCompleted = step.status === 'completed';
              const isCurrent = step.status === 'current';
              const hasAction = step.actionLabel && isCurrent;
              return (
                <div key={i} className="relative pl-6">
                  <div className={`absolute -left-[21px] top-1 w-4 h-4 rounded-full border-2 ${isCompleted ? 'bg-teal-600 border-teal-600' : isCurrent ? 'bg-white border-teal-600 ring-4 ring-teal-50' : 'bg-slate-100 border-slate-300'}`}>{isCompleted && <Icons.CheckCircle2 className="w-3 h-3 text-white absolute top-[-1px] left-[-1px]" />}</div>
                  <div className={`flex flex-col ${isCurrent ? 'opacity-100' : 'opacity-70'}`}>
                    <div className="flex items-center justify-between"><span className={`text-sm font-bold ${isCurrent ? 'text-teal-800' : 'text-slate-900'}`}>{step.title}</span>{step.systemNote && <Badge variant="secondary" className="text-[10px] h-5 bg-slate-100 text-slate-500 font-normal ml-2">{step.systemNote}</Badge>}</div>
                    <span className="text-xs text-slate-500 mt-1">{step.desc}</span>
                    {hasAction && (<div className="mt-3"><Button size="sm" className={`h-8 text-xs rounded-lg ${step.title.includes('Gender') ? 'bg-indigo-600 hover:bg-indigo-700' : ''}`} onClick={() => onAction && onAction(step.actionLabel)}>{step.actionLabel} {step.title.includes('Gender') ? <Icons.Eye className="ml-1.5 h-3 w-3" /> : <Icons.Pencil className="ml-1.5 h-3 w-3" />}</Button></div>)}
                    {isCurrent && !hasAction && (<div className="mt-3"><Badge variant="amber" className="font-normal">In Progress</Badge></div>)}
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      function JourneyProgressCard({ journeyKey, data, onAction }) {
        if (!data || !data.steps) return null;
        const completedSteps = data.steps.filter(s => s.status === 'completed').length;
        const totalSteps = data.steps.length;
        const progressPercent = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;
        const Icon = Icons[data.icon] || Icons.Circle;
        const isMarriage = journeyKey === 'marriage';
        return (
          <Card className="bg-white border-slate-200 overflow-hidden">
            <div className="p-6">
              <div className="flex items-start justify-between gap-4 mb-6">
                <div className="flex items-start gap-4">
                    <div className="h-14 w-14 rounded-2xl bg-teal-50 text-teal-700 flex items-center justify-center shrink-0"><Icon className="h-7 w-7" /></div>
                    <div><div className="flex items-center gap-2 mb-1"><h2 className="text-xl font-bold text-slate-900">{data.title}</h2><Badge variant={data.status === 'Completed' ? 'success' : 'amber'}>{data.status}</Badge></div><p className="text-slate-500 text-sm leading-relaxed">{data.description}</p></div>
                </div>
                {isMarriage && (<Button variant="secondary" size="sm" className="h-8 text-xs shrink-0" onClick={() => onAction && onAction('restart_marriage')}><Icons.Plus className="h-3 w-3 mr-1" /> New Application</Button>)}
              </div>
              <div className="space-y-2"><div className="flex items-center justify-between text-xs font-medium text-slate-700"><span>Journey Progress</span><span>{Math.round(progressPercent)}% ({completedSteps}/{totalSteps} steps)</span></div><Progress value={progressPercent} /></div>
            </div>
          </Card>
        );
      }
      
      function InteractiveAIAssistant({ persona, activeStage, activeProfile }) {
        const [messages, setMessages] = useState([{ role: 'ai', text: `Welcome back. I can help you prepare for your upcoming Life Events.` }]);
        const [input, setInput] = useState("");
        const [isTyping, setIsTyping] = useState(false);
        const [activeTab, setActiveTab] = useState('chat');
        const scrollRef = useRef(null);
        useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, isTyping, activeTab]);
        const handleSend = (text) => {
          const userText = text || input;
          if (!userText.trim()) return;
          setMessages(prev => [...prev, { role: 'user', text: userText }]);
          setInput("");
          setIsTyping(true);
          setTimeout(() => {
            let reply = "I can certainly help with that.";
            const lowerText = userText.toLowerCase();
            if (activeProfile === 'father' && (lowerText.includes('care') || lowerText.includes('home'))) { reply = "I can help you arrange Home Care for your father. Would you like to view available providers in Abu Dhabi?"; } 
            else if (lowerText.includes('eligibility')) { reply = "I've checked your profile. You are eligible for the Premarital Screening. Would you like to book an appointment?"; }
            else if (lowerText.includes('book')) { reply = "I can show you the nearest SEHA facilities. Please select 'Booking' in the journey card."; }
            else if (lowerText.includes('mabrouk') || lowerText.includes('birth certificate')) { if (persona === 'citizen') { reply = "As a Citizen, your Birth Certificate is part of the 'Mabrouk Ma Yak' bundle. Once the hospital notification is received, we'll issue the Certificate, EID, and Passport automatically."; } else { reply = "For Residents, you'll first issue the Birth Certificate. Then I can guide you through MOFA Attestation and the Embassy Passport application."; } }
            else if (lowerText.includes('apply')) { if (lowerText.includes('housing')) { if (persona === 'citizen') { reply = "I've checked your Family Book status. You are eligible for Housing Assistance. I have auto-submitted your application. Reference: HSG-9921."; } else { reply = "Housing assistance via ISKAN is currently available for UAE Citizens. Please check the 'Work & Leave' section for employer support."; } } else if (lowerText.includes('leave')) { reply = "I have connected with your employer. Your Paternity Leave request for 5 days has been drafted. Status: Pending Employer Action."; } else { reply = "I can help you apply for Housing or Leave. Which one would you like?"; } }
            else if (lowerText.includes('doc')) { reply = "Your verified Family Book is in the wallet below. Future documents like the Birth Certificate will appear there automatically."; }
            setMessages(prev => [...prev, { role: 'ai', text: reply }]);
            setIsTyping(false);
          }, 1200);
        };
        const insights = getAIInsights(persona, activeStage, activeProfile);
        return (<Card className="flex flex-col h-[420px] shadow-lg border-0 bg-slate-900 text-white overflow-hidden"><div className="p-4 border-b border-slate-700 bg-slate-800/50 flex flex-col gap-3"><div className="flex items-center gap-2"><div className="h-8 w-8 rounded-full bg-teal-500 flex items-center justify-center shadow-lg shadow-teal-500/20"><Icons.Sparkles className="h-4 w-4 text-white" /></div><div><h3 className="text-sm font-bold">AI Companion</h3><p className="text-xs text-slate-400">Smart Support & Insights</p></div></div><div className="flex bg-slate-800/80 p-1 rounded-lg"><button onClick={() => setActiveTab('chat')} className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${activeTab === 'chat' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Chat</button><button onClick={() => setActiveTab('insights')} className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${activeTab === 'insights' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Insights <span className="ml-1 bg-teal-600 text-[9px] px-1 rounded-full">{insights.length}</span></button></div></div>{activeTab === 'chat' ? (<><div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>{messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-slide-up`}><div className={`max-w-[85%] rounded-2xl px-4 py-2.5 text-sm leading-relaxed ${m.role === 'user' ? 'bg-teal-600 text-white rounded-tr-sm' : 'bg-slate-800 text-slate-200 rounded-tl-sm'}`}>{m.text}</div></div>))}{isTyping && (<div className="flex justify-start animate-slide-up"><div className="bg-slate-800 rounded-2xl rounded-tl-sm px-4 py-3"><div className="flex gap-1"><span className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce"></span><span className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></span><span className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></span></div></div></div>)}</div><div className="p-3 bg-slate-800/50 space-y-3"><div className="flex gap-2 overflow-x-auto hide-scrollbar pb-1">{activeProfile !== 'father' && persona === 'citizen' && (<button onClick={() => handleSend("Apply for housing grants")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Apply for housing grants</button>)}<button onClick={() => handleSend("Request Leave")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Request Leave</button><button onClick={() => handleSend("Check eligibility")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Eligibility</button>{activeProfile === 'me' && persona === 'citizen' && (<button onClick={() => handleSend("How does Mabrouk Ma Yak work?")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Mabrouk Ma Yak info</button>)}</div><div className="flex gap-2"><input className="flex-1 bg-slate-950/50 border border-slate-700 rounded-xl px-4 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all" placeholder="Ask anything..." value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} /><button onClick={() => handleSend()} className="h-10 w-10 rounded-xl bg-teal-600 hover:bg-teal-500 flex items-center justify-center transition-colors"><Icons.Send className="h-4 w-4" /></button></div></div></>) : (<div className="flex-1 overflow-y-auto p-4 space-y-3"><div className="flex items-center justify-between mb-2"><h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Recommended for you</h4><Badge variant="secondary" className="bg-slate-800 text-slate-300 text-[10px] h-5 border-0">Based on {activeStage}</Badge></div>{insights.map((item, idx) => { const Icon = Icons[item.icon] || Icons.Lightbulb; return (<div key={idx} className="bg-slate-800/50 hover:bg-slate-800 border border-slate-700 rounded-xl p-3 transition-colors cursor-pointer group"><div className="flex items-start gap-3"><div className={`p-2 rounded-lg shrink-0 ${item.type === 'service' ? 'bg-teal-900/30 text-teal-400' : 'bg-purple-900/30 text-purple-400'}`}><Icon className="h-4 w-4" /></div><div className="flex-1"><div className="flex items-center gap-2 mb-1"><Badge variant="outline" className={`text-[10px] h-4 px-1.5 border-0 ${item.type === 'service' ? 'bg-teal-900/50 text-teal-300' : 'bg-purple-900/50 text-purple-300'}`}>{item.type === 'service' ? 'Service' : item.type === 'tip' ? 'Smart Tip' : 'Education'}</Badge></div><h5 className="text-sm font-medium text-white group-hover:text-teal-300 transition-colors">{item.title}</h5><p className="text-xs text-slate-400 mt-1 leading-relaxed">{item.desc}</p></div><Icons.ChevronDown className="-rotate-90 h-4 w-4 text-slate-600 group-hover:text-white transition-colors" /></div></div>) })}</div>)}</Card>);
      }

      function LifeEventsMedicalHubDashboard() {
        const [personaKey, setPersonaKey] = useState("citizen");
        const [activeProfile, setActiveProfile] = useState("me"); 
        const [activeJourneyKey, setActiveJourneyKey] = useState("maternity"); 
        const [babyName, setBabyName] = useState(null);
        const [revealedGender, setRevealedGender] = useState(null);
        const [activeDocument, setActiveDocument] = useState(null); // Track which doc is open

        const [isCustomizeOpen, setIsCustomizeOpen] = useState(false);
        const [isNamingModalOpen, setIsNamingModalOpen] = useState(false);
        const [isRevealModalOpen, setIsRevealModalOpen] = useState(false);

        const personas = getPersonas(babyName, revealedGender);
        const activePersona = personas[personaKey];
        const JOURNEY_DATA = useMemo(() => getJourneyData(personaKey, babyName, revealedGender), [personaKey, babyName, revealedGender]);

        const handleJourneyClick = (key) => { setActiveJourneyKey(key); };
        const handleTimelineAction = (actionLabel) => { if (actionLabel === "Start Naming" || actionLabel === "Issue Certificate") { setIsNamingModalOpen(true); } if (actionLabel === "Reveal Gender") { setIsRevealModalOpen(true); } };
        const handleNameSubmit = (name) => { setBabyName(name); };
        const handleGenderReveal = (gender) => { setRevealedGender(gender); };
        const handleRestartMarriage = () => { alert("New Marriage Application Started! (Prototype: Data reset)"); };
        
        // --- VISIBILITY LOGIC (Spine) ---
        const [visibleJourneyIds, setVisibleJourneyIds] = useState(["premarital", "marriage", "preconception", "maternity", "birth", "child_health", "adolescent", "adult", "elderly", "sanadkom"]);
        const toggleJourneyVisibility = (id) => { setVisibleJourneyIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]); };

        const getSpineForProfile = (profile) => {
            if (profile === 'me') {
                return [
                    { id: "premarital", label: "Premarital", type: 'main', branches: [] },
                    { id: "marriage", label: "Marriage", type: 'main', branches: [{id: 'preconception', label: 'Family Planning', icon: 'HeartPulse'}, {id: 'housing', label: 'Housing Grant', icon: 'Home'}] },
                    { id: "maternity", label: "Maternity", type: 'main', branches: [{id: 'work', label: 'Leave', icon: 'Briefcase'}] },
                    { id: "birth", label: personaKey === 'citizen' ? "Mabrouk Ma Yak" : "Birth & Residency", type: 'main', branches: [] },
                    { id: "adult", label: "Adult Health", type: 'main', branches: [{id: 'work_screening', label: 'Work Fitness', icon: 'Briefcase'}, {id: 'hajj', label: 'Hajj & Umrah', icon: 'Moon'}] }
                ];
            } else if (profile === 'family') { 
                return [
                    { id: "newborn", label: "Newborn (0-2m)", type: 'main', branches: [] },
                    { id: "early_childhood", label: "Child (2m-4y)", type: 'main', branches: [] },
                    { id: "school_age", label: "School Age (4-12y)", type: 'main', branches: [{id: 'education', label: 'School Entry', icon: 'GraduationCap'}] },
                    { id: "adolescent", label: "Adolescent (13+)", type: 'main', branches: [{id: 'university', label: 'University', icon: 'BookOpen'}] }
                ];
            } else if (profile === 'father') {
                return [
                    { id: "elderly", label: "Elderly Care", type: 'main', branches: [{id: 'sanadkom', label: 'Sanadkom', icon: 'Heart'}] }
                ];
            }
            return [];
        };

        const VISIBLE_SPINE = getSpineForProfile(activeProfile);

        useEffect(() => {
             if (VISIBLE_SPINE.length > 0) {
                 setActiveJourneyKey(VISIBLE_SPINE[0].id);
             }
        }, [activeProfile]);

        return (
          <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 pb-20">
            <div className="max-w-7xl mx-auto space-y-6">
              
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                  <div className="h-12 w-12 rounded-2xl bg-teal-700 text-white flex items-center justify-center shadow-sm"><Icons.Activity className="h-6 w-6" /></div>
                  <div><div className="text-xs font-bold text-slate-500 uppercase tracking-wide">TAMM</div><h1 className="text-2xl font-bold text-slate-900">Life Events Medical Hub</h1></div>
                </div>
                <div className="bg-white rounded-xl border border-slate-200 p-1 flex items-center shadow-sm">
                  <button onClick={() => { setPersonaKey("citizen"); setBabyName(null); setRevealedGender(null); }} className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${personaKey === 'citizen' ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}>Citizen</button>
                  <button onClick={() => { setPersonaKey("resident"); setBabyName(null); setRevealedGender(null); }} className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${personaKey === 'resident' ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}>Resident</button>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <Card onClick={() => setActiveProfile('me')} className={`cursor-pointer transition-all hover:border-teal-300 ${activeProfile === 'me' ? 'ring-2 ring-teal-600 bg-teal-50/50' : 'opacity-80 hover:opacity-100'}`}>
                      <CardContent className="p-4 flex items-center gap-3">
                          <div className={`h-12 w-12 rounded-full flex items-center justify-center border-2 ${activeProfile === 'me' ? 'bg-teal-600 text-white border-teal-200' : 'bg-slate-100 text-slate-400 border-white'}`}><Icons.User className="h-6 w-6" /></div>
                          <div><div className="text-sm font-bold text-slate-900">Myself</div><div className="text-xs text-slate-500">Omar Al Nuaimi</div></div>
                      </CardContent>
                  </Card>
                  <Card onClick={() => setActiveProfile('family')} className={`cursor-pointer transition-all hover:border-teal-300 ${activeProfile === 'family' ? 'ring-2 ring-teal-600 bg-teal-50/50' : 'opacity-80 hover:opacity-100'}`}>
                      <CardContent className="p-4 flex items-center gap-3">
                          <div className={`h-12 w-12 rounded-full flex items-center justify-center border-2 ${activeProfile === 'family' ? 'bg-teal-600 text-white border-teal-200' : 'bg-slate-100 text-slate-400 border-white'}`}><Icons.Users2 className="h-6 w-6" /></div>
                          <div><div className="text-sm font-bold text-slate-900">My Children</div><div className="text-xs text-slate-500">2 Dependents</div></div>
                      </CardContent>
                  </Card>
                  <Card onClick={() => setActiveProfile('father')} className={`cursor-pointer transition-all hover:border-teal-300 ${activeProfile === 'father' ? 'ring-2 ring-teal-600 bg-teal-50/50' : 'opacity-80 hover:opacity-100'}`}>
                      <CardContent className="p-4 flex items-center gap-3">
                          <div className={`h-12 w-12 rounded-full flex items-center justify-center border-2 ${activeProfile === 'father' ? 'bg-teal-600 text-white border-teal-200' : 'bg-slate-100 text-slate-400 border-white'}`}><Icons.User className="h-6 w-6" /></div>
                          <div><div className="text-sm font-bold text-slate-900">My Father</div><div className="text-xs text-slate-500">Mohammed Al Nuaimi</div></div>
                      </CardContent>
                  </Card>
              </div>

              <div className="relative pt-2">
                  <div className="overflow-x-auto pb-16 pt-4 hide-scrollbar">
                    <div className="flex items-center min-w-max px-4 relative">
                        <div className="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -z-10 rounded-full" style={{top: '50%', transform: 'translateY(-50%)'}}></div>
                        {VISIBLE_SPINE.map((s, i) => {
                             const isActive = activeJourneyKey === s.id;
                             const hasBranch = s.branches && s.branches.length > 0;
                             
                             return (
                                <div key={s.id} className="flex flex-col items-center relative mx-8 group">
                                    <div className="relative z-10">
                                        <button onClick={() => handleJourneyClick(s.id)} className={`w-14 h-14 rounded-full flex items-center justify-center border-4 transition-all z-10 relative bg-white ${isActive ? 'border-teal-600 ring-4 ring-teal-50 shadow-lg scale-110' : 'border-slate-200 text-slate-400 hover:border-teal-300 hover:text-teal-600'}`}><div className={`w-3 h-3 rounded-full ${isActive ? 'bg-teal-600' : 'bg-slate-300 group-hover:bg-teal-400'}`}></div></button>
                                    </div>
                                    <div className="mt-2 text-xs font-bold text-center h-8 flex items-start justify-center z-20">
                                        <span className={`whitespace-nowrap ${isActive ? 'text-teal-900' : 'text-slate-500'}`}>{s.label}</span>
                                    </div>
                                    {hasBranch && (
                                        <div className="flex flex-col items-center w-full">
                                            <div className="h-4 w-0.5 bg-slate-300"></div> 
                                            <div className="flex justify-center gap-4 relative">
                                                 {s.branches.length > 1 && (<div className="absolute top-0 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] h-0.5 bg-slate-300"></div>)}
                                                 {s.branches.map((branch, bIdx) => {
                                                     const isBranchActive = activeJourneyKey === branch.id;
                                                     const BranchIcon = Icons[branch.icon] || Icons.GitBranch;
                                                     const offsetX = s.branches.length > 1 ? (bIdx === 0 ? '-translate-x-6' : 'translate-x-6') : '';
                                                     return (
                                                         <div key={branch.id} className={`flex flex-col items-center relative pt-2`}>
                                                             {s.branches.length > 1 && <div className="absolute top-0 h-2 w-0.5 bg-slate-300"></div>}
                                                             <button onClick={() => handleJourneyClick(branch.id)} className={`w-10 h-10 rounded-full flex items-center justify-center border-2 shadow-sm transition-all z-10 mt-0 bg-white ${isBranchActive ? 'border-amber-500 text-amber-600 ring-2 ring-amber-100 scale-110' : 'border-slate-200 text-slate-400 hover:border-amber-300 hover:text-amber-500'}`}><BranchIcon className="h-4 w-4" /></button>
                                                             <span className={`text-[10px] font-bold mt-1 whitespace-nowrap px-1.5 py-0.5 rounded ${isBranchActive ? 'text-amber-700 bg-amber-50' : 'text-slate-400'}`}>{branch.label}</span>
                                                         </div>
                                                     )
                                                 })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                             )
                        })}
                    </div>
                  </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                <div className="lg:col-span-2 space-y-8">
                  {JOURNEY_DATA[activeJourneyKey] ? (
                      <>
                        <JourneyProgressCard journeyKey={activeJourneyKey} data={JOURNEY_DATA[activeJourneyKey]} onAction={(action) => { if(action === 'restart_marriage') handleRestartMarriage(); }} />
                        <Card className="bg-white overflow-hidden min-h-[300px]">
                            <div className="p-6">
                                <div className="flex items-center gap-2 mb-6"><Icons.ListTodo className="h-5 w-5 text-teal-600" /><h3 className="font-bold text-lg text-slate-900">Your Action Plan</h3></div>
                                <JourneyTimeline data={JOURNEY_DATA[activeJourneyKey]} onAction={handleTimelineAction} />
                            </div>
                        </Card>
                      </>
                  ) : (
                      <div className="p-8 text-center text-slate-400 bg-slate-100 rounded-2xl border border-dashed border-slate-300">Select a journey from the map above to view details.</div>
                  )}
                </div>

                <div className="space-y-6">
                  <InteractiveAIAssistant persona={personaKey} activeStage={activeJourneyKey} activeProfile={activeProfile} />
                  <Card>
                    <CardHeader className="pb-3 border-b border-slate-100 bg-slate-50/50"><div className="flex items-center justify-between"><CardTitle className="text-base flex items-center gap-2"><Icons.FileText className="h-4 w-4" /> Documents</CardTitle><Badge variant="outline" className="bg-white">Digital Locker</Badge></div></CardHeader>
                    <CardContent className="pt-0">
                        <div className="py-3">
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-1">Ready</div>
                            <div className="space-y-2">
                                <div 
                                    onClick={() => setActiveDocument('Family Book')}
                                    className="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-100 cursor-pointer"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-teal-50 rounded text-teal-600"><Icons.CheckCircle2 className="h-4 w-4" /></div>
                                        <div><div className="text-sm font-medium text-slate-900">Family Book</div><div className="text-[10px] text-slate-500">Updated: Today</div></div>
                                    </div>
                                    <Badge variant="outline" className="text-[10px] bg-white">Active</Badge>
                                </div>
                                <div 
                                    onClick={() => setActiveDocument('Marriage Contract')}
                                    className="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-100 cursor-pointer"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-teal-50 rounded text-teal-600"><Icons.CheckCircle2 className="h-4 w-4" /></div>
                                        <div><div className="text-sm font-medium text-slate-900">Marriage Contract</div><div className="text-[10px] text-slate-500">Issued: 2024</div></div>
                                    </div>
                                    <Badge variant="outline" className="text-[10px] bg-white">Verified</Badge>
                                </div>
                            </div>
                        </div>
                        <Separator />
                        <div className="py-3">
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-1">Pending</div>
                            <div className="space-y-2">
                                <div 
                                    onClick={() => setActiveDocument('Birth Certificate')}
                                    className="flex items-center justify-between p-2 rounded-lg bg-amber-50/50 border border-amber-100 cursor-pointer"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-amber-100 rounded text-amber-600"><Icons.Clock className="h-4 w-4" /></div>
                                        <div><div className="text-sm font-medium text-slate-900">Birth Certificate</div><div className="text-[10px] text-slate-500">Draft - Awaiting Name</div></div>
                                    </div>
                                    <div className="text-amber-600"><Icons.ArrowRight className="h-4 w-4" /></div>
                                </div>
                            </div>
                        </div>
                    </CardContent>
                  </Card>
                </div>
              </div>

              <BabyNamingModal isOpen={isNamingModalOpen} onClose={() => setIsNamingModalOpen(false)} onNameSubmit={handleNameSubmit} persona={personaKey} />
              <GenderRevealModal isOpen={isRevealModalOpen} onClose={() => setIsRevealModalOpen(false)} onReveal={handleGenderReveal} />
              
              {/* Document Modal */}
              <DocumentPreviewModal 
                  isOpen={!!activeDocument} 
                  onClose={() => setActiveDocument(null)} 
                  docType={activeDocument} 
                  persona={personaKey} 
                  babyName={babyName}
              />

            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<LifeEventsMedicalHubDashboard />);
    </script>
  </body>
</html>
